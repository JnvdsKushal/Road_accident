{% extends 'base.html' %}
{% block content %}
<section class="grid" style="grid-template-columns: repeat(12, 1fr);">
  <div class="card" style="grid-column: span 8;">
    <div class="body">
      <h2 style="margin:0 0 6px 0;">Accident Probability</h2>
      <p style="margin:0 0 16px 0; color: var(--muted);">Provide situational factors or auto-detect weather via geolocation.</p>
      <form id="predictForm" novalidate>
        <div class="grid" style="grid-template-columns: repeat(12, 1fr);">
          <div style="grid-column: span 6; padding: 8px;">
            <label for="weather" class="lbl">Weather</label>
            <select id="weather" class="fld">
              <option value="">Select...</option>
              <option value="1">Clear</option>
              <option value="2">Rain</option>
              <option value="3">Snow</option>
              <option value="7">Fog/Mist</option>
            </select>
          </div>
          <div style="grid-column: span 6; padding: 8px;">
            <label for="roadsc" class="lbl">Road Surface</label>
            <select id="roadsc" class="fld">
              <option value="">Select...</option>
              <option value="1">Dry</option>
              <option value="2">Wet</option>
              <option value="3">Snow</option>
              <option value="4">Ice</option>
            </select>
          </div>

          <div style="grid-column: span 4; padding: 8px;">
            <label for="traffic" class="lbl">Traffic Density (1-5)</label>
            <input id="traffic" class="fld" type="number" min="1" max="5" placeholder="3">
          </div>
          <div style="grid-column: span 4; padding: 8px;">
            <label for="speed" class="lbl">Vehicle Speed (km/h)</label>
            <input id="speed" class="fld" type="number" placeholder="30">
          </div>
          <div style="grid-column: span 4; padding: 8px;">
            <label for="time" class="lbl">Time of Day (0-23)</label>
            <input id="time" class="fld" type="number" min="0" max="23" placeholder="14">
          </div>

          <div style="grid-column: span 4; padding: 8px;">
            <label for="age" class="lbl">Driver Age</label>
            <input id="age" class="fld" type="number" placeholder="30">
          </div>
          <div style="grid-column: span 4; padding: 8px;">
            <label for="vtype" class="lbl">Vehicle Type (code)</label>
            <input id="vtype" class="fld" type="number" placeholder="9">
          </div>
          <div style="grid-column: span 4; padding: 8px;">
            <label for="speed_limit" class="lbl">Speed Limit</label>
            <input id="speed_limit" class="fld" type="number" placeholder="30">
          </div>
        </div>

        <div style="display:flex; gap:10px; align-items:center; padding: 8px; margin-top: 6px;">
          <button id="geoBtn" type="button" class="btn ghost">Use My Location</button>
          <button id="submitBtn" type="submit" class="btn primary">Predict</button>
          <div id="spinner" class="spinner" style="display:none;"></div>
        </div>
      </form>
    </div>
  </div>

  <div class="card" style="grid-column: span 4;">
    <div class="body">
      <h3 style="margin:0 0 12px 0;">Driver Risk Score</h3>
      <div id="riskScore" style="font-size:42px; font-weight:800; text-align:center;">--</div>
      <p style="color:var(--muted); text-align:center;">0 (low) to 100 (high)</p>
      <ul style="margin:12px 0 0 0; padding-left: 18px; color: var(--muted);">
        <li>Keep distance in rain.</li>
        <li>Reduce speed in low visibility.</li>
        <li>Always wear seatbelts.</li>
      </ul>
    </div>
  </div>

  <div id="resultCard" class="card" style="grid-column: span 12; display:none;">
    <div class="body">
      <div style="display:flex; align-items:center; gap:10px;">
        <div id="predictionBadge" class="pill">--</div>
        <p id="predictionText" style="margin:0; color:var(--muted);"></p>
      </div>
    </div>
  </div>
</section>

<style>
  .lbl { display: block; margin: 0 0 8px 0; color: var(--text); font-size: 0.9rem; font-weight: 500; }
  .fld { 
    width: 100%; 
    padding: 12px 14px; 
    background: #ffffff; 
    color: var(--text); 
    border: 1.5px solid var(--border); 
    border-radius: 8px; 
    outline: none; 
    font-size: 0.95rem;
    transition: all 0.2s ease;
  }
  .fld:hover { border-color: var(--primary); }
  .fld:focus { 
    border-color: var(--primary); 
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); 
  }
  .btn { 
    padding: 12px 20px; 
    border-radius: 8px; 
    border: 1.5px solid var(--border); 
    background: #ffffff; 
    color: var(--text); 
    cursor: pointer; 
    transition: all 0.2s ease; 
    font-size: 0.9rem;
    font-weight: 500;
  }
  .btn:hover { 
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,.1);
  }
  .btn.primary { 
    background: linear-gradient(135deg, var(--primary), var(--accent)); 
    color: white; 
    border: none; 
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }
  .btn.primary:hover {
    box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    transform: translateY(-2px);
  }
  .btn.ghost { 
    background: transparent; 
    border: 1.5px solid var(--border);
  }
  .spinner { 
    width: 20px; 
    height: 20px; 
    border: 3px solid var(--border); 
    border-top-color: var(--primary); 
    border-radius: 50%; 
    animation: spin 0.8s linear infinite; 
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .pill { 
    padding: 8px 16px; 
    border-radius: 999px; 
    border: 1.5px solid var(--border); 
    background: #f8fafc; 
    font-weight: 600; 
    font-size: 0.9rem;
  }
  #resultCard {
    animation: slideIn 0.4s ease;
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @media (max-width: 900px) { 
    [style*="grid-column: span 8"] { grid-column: span 12 !important; } 
    [style*="grid-column: span 4"] { grid-column: span 12 !important; } 
  }
</style>

<script>
  const form = document.getElementById('predictForm');
  const spinner = document.getElementById('spinner');
  const resultCard = document.getElementById('resultCard');
  const predictionBadge = document.getElementById('predictionBadge');
  const predictionText = document.getElementById('predictionText');
  const riskScoreEl = document.getElementById('riskScore');

  function validate() {
    const required = ['weather','roadsc','traffic','speed','time','age','vtype','speed_limit'];
    for (const id of required) {
      const el = document.getElementById(id);
      if (!el.value) { el.focus(); return false; }
    }
    return true;
  }

  document.getElementById('geoBtn').addEventListener('click', () => {
    if (!navigator.geolocation) return alert('Geolocation not supported');
    navigator.geolocation.getCurrentPosition(() => {
      document.getElementById('weather').value = '2';
      document.getElementById('roadsc').value = '2';
    }, () => alert('Location permission denied'));
  });

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    if (!validate()) { alert('Please fill all fields'); return; }
    spinner.style.display = 'inline-block';
    resultCard.style.display = 'none';
    setTimeout(() => {
      spinner.style.display = 'none';
      const speed = Number(document.getElementById('speed').value || 0);
      const traffic = Number(document.getElementById('traffic').value || 1);
      const time = Number(document.getElementById('time').value || 12);
      const base = Math.min(0.95, (speed/120) * 0.5 + (traffic/5) * 0.3 + (time > 20 || time < 6 ? 0.15 : 0));
      const pct = Math.round(base * 100);
      predictionBadge.textContent = pct + '% risk';
      predictionBadge.style.borderColor = pct > 60 ? 'rgba(248,113,113,.6)' : pct > 30 ? 'rgba(251,191,36,.6)' : 'rgba(52,211,153,.6)';
      predictionText.textContent = pct > 60 ? 'High risk detected. Consider rerouting or delaying travel.' : pct > 30 ? 'Moderate risk. Drive cautiously.' : 'Low risk. Stay alert and follow road rules.';
      riskScoreEl.textContent = Math.min(100, Math.round(pct * 1.1));
      resultCard.style.display = 'block';
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }, 900);
  });
</script>
{% endblock %}
